---
- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç dos –∞—Ç–∞–∫
  hosts: localhost
  connection: local
  become: yes
  
  tasks:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban
      apt:
        name: fail2ban
        state: present
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Apache
      apt:
        name: apache2
        state: present
    
    - name: –ó–∞–ø—É—Å–∫ Apache
      service:
        name: apache2
        state: started
        enabled: yes
    
    - name: –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ jail –¥–ª—è –≤—Å–µ—Ö –∞—Ç–∞–∫
      copy:
        dest: /etc/fail2ban/jail.d/block-fast.conf
        content: |
          [block-fast]
          enabled = true
          port = http,https
          filter = block-fast
          logpath = /var/log/apache2/access.log
          maxretry = 15
          findtime = 10
          bantime = 300
          action = iptables-allports[name=block-fast]
    
    - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
      copy:
        dest: /etc/fail2ban/filter.d/block-fast.conf
        content: |
          [Definition]
          failregex = ^<HOST> -.*".*".*$
          ignoreregex = ^127\.0\.0\.1.*$
    
    - name: –ó–∞–ø—É—Å–∫ fail2ban
      service:
        name: fail2ban
        state: started
        enabled: yes
    
    - name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ fail2ban
      pause:
        seconds: 3
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ fail2ban
      command: fail2ban-client status
      register: status
      changed_when: false
      ignore_errors: yes
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ jail block-fast
      command: fail2ban-client status block-fast
      register: jail_status
      changed_when: false
      ignore_errors: yes

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å mod_evasive
      apt: name=libapache2-mod-evasive state=present
    
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mod_evasive
      copy:
        dest: /etc/apache2/mods-available/evasive.conf
        content: |
          <IfModule mod_evasive20.c>
          DOSHashTableSize 3097
          DOSPageCount 2
          DOSSiteCount 50
          DOSPageInterval 1
          DOSSiteInterval 1
          DOSBlockingPeriod 10
          DOSSLowAttackTime 60
          DOSSLowAttackLimit 100
          </IfModule>
    
    - name: –í–∫–ª—é—á–µ–Ω–∏–µ mod_evasive
      apache2_module:
        name: evasive
        state: present
    
    - name: –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      debug:
        msg: |
          üîß –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!
          
          –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:
          ‚úÖ fail2ban
          ‚úÖ Apache
          ‚úÖ –ö–æ–Ω—Ñ–∏–≥ –∑–∞—â–∏—Ç—ã block-fast
          ‚úÖ mod_evasive
          
          {% if status is succeeded %}
          –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å: {{ status.stdout }}
          {% else %}
          –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å: ‚ùå fail2ban –µ—â—ë –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...
          {% endif %}
          
          {% if jail_status is succeeded %}
          Jail 'block-fast': {{ jail_status.stdout }}
          {% else %}
          Jail 'block-fast': ‚ùå –µ—â—ë –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
          {% endif %}